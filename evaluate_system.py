import sqlalchemy
from sqlalchemy import text
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import logging

# Logging ayarlarƒ±
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Veritabanƒ± baƒülantƒ±sƒ±
DATABASE_URL = 'postgresql://laravel:secret@localhost:5432/kahin_ultima'
engine = sqlalchemy.create_engine(DATABASE_URL)

def evaluate_system_performance():
    """Sistem performansƒ±nƒ± kapsamlƒ± deƒüerlendir"""
    try:
        print("üîç Sƒ∞STEM PERFORMANS DEƒûERLENDƒ∞RMESƒ∞")
        print("=" * 50)
        
        with engine.connect() as conn:
            # 1. Genel ƒ∞statistikler
            print("\nüìä GENEL ƒ∞STATƒ∞STƒ∞KLER")
            print("-" * 30)
            
            # Toplam sinyal sayƒ±sƒ±
            total_query = "SELECT COUNT(*) as total FROM signals"
            total_result = conn.execute(text(total_query))
            total_signals = total_result.scalar()
            print(f"Toplam Sinyal: {total_signals}")
            
            # Son 30 g√ºnl√ºk sinyaller
            recent_query = """
                SELECT COUNT(*) as recent FROM signals 
                WHERE timestamp::timestamp >= NOW() - INTERVAL '30 days'
            """
            recent_result = conn.execute(text(recent_query))
            recent_signals = recent_result.scalar()
            print(f"Son 30 G√ºn: {recent_signals}")
            
            # 2. Sinyal Kalitesi Analizi
            print("\nüéØ Sƒ∞NYAL KALƒ∞TESƒ∞")
            print("-" * 30)
            
            # AI skorlarƒ±
            ai_score_query = """
                SELECT 
                    AVG(ai_score) as avg_ai_score,
                    MIN(ai_score) as min_ai_score,
                    MAX(ai_score) as max_ai_score,
                    STDDEV(ai_score) as std_ai_score
                FROM signals 
                WHERE ai_score IS NOT NULL
            """
            ai_score_result = conn.execute(text(ai_score_query))
            ai_stats = ai_score_result.fetchone()
            
            print(f"Ortalama AI Skoru: {ai_stats[0]:.3f}")
            print(f"En D√º≈ü√ºk AI Skoru: {ai_stats[1]:.3f}")
            print(f"En Y√ºksek AI Skoru: {ai_stats[2]:.3f}")
            print(f"AI Skor Standart Sapmasƒ±: {ai_stats[3]:.3f}")
            
            # Y√ºksek kaliteli sinyaller (AI skoru > 0.8)
            high_quality_query = """
                SELECT COUNT(*) as high_quality
                FROM signals 
                WHERE ai_score > 0.8
            """
            high_quality_result = conn.execute(text(high_quality_query))
            high_quality_count = high_quality_result.scalar()
            high_quality_percentage = (high_quality_count / total_signals * 100) if total_signals > 0 else 0
            print(f"Y√ºksek Kaliteli Sinyaller (>0.8): {high_quality_count} ({high_quality_percentage:.1f}%)")
            
            # 3. Ba≈üarƒ± Oranƒ± Analizi
            print("\nüìà BA≈ûARI ORANI")
            print("-" * 30)
            
            # Tamamlanmƒ±≈ü sinyaller
            completed_query = """
                SELECT 
                    COUNT(*) as completed,
                    COUNT(CASE WHEN result = 'profit' THEN 1 END) as profitable,
                    COUNT(CASE WHEN result = 'loss' THEN 1 END) as loss,
                    COUNT(CASE WHEN result = 'TIMEOUT' THEN 1 END) as timeout
                FROM signals 
                WHERE result IS NOT NULL AND result != 'None'
            """
            completed_result = conn.execute(text(completed_query))
            completed_stats = completed_result.fetchone()
            
            completed_count = completed_stats[0]
            profitable_count = completed_stats[1]
            loss_count = completed_stats[2]
            timeout_count = completed_stats[3]
            
            if completed_count > 0:
                success_rate = (profitable_count / completed_count) * 100
                loss_rate = (loss_count / completed_count) * 100
                timeout_rate = (timeout_count / completed_count) * 100
                
                print(f"Tamamlanmƒ±≈ü Sinyal: {completed_count}")
                print(f"Kazan√ßlƒ±: {profitable_count} ({success_rate:.1f}%)")
                print(f"Zararlƒ±: {loss_count} ({loss_rate:.1f}%)")
                print(f"Zaman A≈üƒ±mƒ±: {timeout_count} ({timeout_rate:.1f}%)")
            else:
                print("Hen√ºz tamamlanmƒ±≈ü sinyal yok")
            
            # 4. Ortalama Kazan√ß/Kayƒ±p
            print("\nüí∞ KAZAN√á/KAYIP ANALƒ∞Zƒ∞")
            print("-" * 30)
            
            if completed_count > 0:
                profit_query = """
                    SELECT 
                        AVG(realized_gain) as avg_gain,
                        SUM(realized_gain) as total_gain,
                        MIN(realized_gain) as min_gain,
                        MAX(realized_gain) as max_gain
                    FROM signals 
                    WHERE result IS NOT NULL AND result != 'None' AND realized_gain IS NOT NULL
                """
                profit_result = conn.execute(text(profit_query))
                profit_stats = profit_result.fetchone()
                
                print(f"Ortalama Kazan√ß/Kayƒ±p: {profit_stats[0]:.2f}%")
                print(f"Toplam Kazan√ß/Kayƒ±p: {profit_stats[1]:.2f}%")
                print(f"En D√º≈ü√ºk: {profit_stats[2]:.2f}%")
                print(f"En Y√ºksek: {profit_stats[3]:.2f}%")
            
            # 5. Model Performansƒ±
            print("\nü§ñ MODEL PERFORMANSI")
            print("-" * 30)
            
            # Teknik analiz skorlarƒ±
            ta_query = """
                SELECT 
                    AVG(ta_strength) as avg_ta,
                    AVG(whale_score) as avg_whale,
                    AVG(social_score) as avg_social,
                    AVG(news_score) as avg_news,
                    AVG(breakout_probability) as avg_breakout
                FROM signals 
                WHERE ta_strength IS NOT NULL
            """
            ta_result = conn.execute(text(ta_query))
            ta_stats = ta_result.fetchone()
            
            print(f"Ortalama Teknik Analiz: {ta_stats[0]:.3f}")
            print(f"Ortalama Whale Skoru: {ta_stats[1]:.3f}")
            print(f"Ortalama Sosyal Skor: {ta_stats[2]:.3f}")
            print(f"Ortalama Haber Skoru: {ta_stats[3]:.3f}")
            print(f"Ortalama Breakout Olasƒ±lƒ±ƒüƒ±: {ta_stats[4]:.3f}")
            
            # 6. Sistem Saƒülƒ±ƒüƒ±
            print("\nüè• Sƒ∞STEM SAƒûLIƒûI")
            print("-" * 30)
            
            # Son sinyal tarihi
            last_signal_query = "SELECT MAX(timestamp) as last_signal FROM signals"
            last_signal_result = conn.execute(text(last_signal_query))
            last_signal_time = last_signal_result.scalar()
            
            if last_signal_time:
                # String'i datetime'a √ßevir
                if isinstance(last_signal_time, str):
                    last_signal_time = datetime.fromisoformat(last_signal_time.replace('Z', '+00:00'))
                
                time_diff = datetime.now() - last_signal_time
                hours_since_last = time_diff.total_seconds() / 3600
                print(f"Son Sinyal: {last_signal_time}")
                print(f"Son Sinyalden Bu Yana: {hours_since_last:.1f} saat")
                
                if hours_since_last < 24:
                    print("‚úÖ Sistem aktif")
                    system_health_score = 15
                elif hours_since_last < 72:
                    print("‚ö†Ô∏è Sistem yava≈ü")
                    system_health_score = 10
                else:
                    print("‚ùå Sistem pasif")
                    system_health_score = 5
            else:
                print("Son sinyal bilgisi bulunamadƒ±")
                system_health_score = 0
            
            # 7. Sinyal Daƒüƒ±lƒ±mƒ±
            print("\nüìä Sƒ∞NYAL DAƒûILIMI")
            print("-" * 30)
            
            # En √ßok sinyal √ºretilen coinler
            top_coins_query = """
                SELECT symbol, COUNT(*) as count
                FROM signals 
                GROUP BY symbol 
                ORDER BY count DESC 
                LIMIT 10
            """
            top_coins_result = conn.execute(text(top_coins_query))
            top_coins = top_coins_result.fetchall()
            
            print("En √áok Sinyal √úretilen Coinler:")
            for i, (symbol, count) in enumerate(top_coins, 1):
                print(f"{i}. {symbol}: {count} sinyal")
            
            # 8. Genel Puanlama
            print("\n‚≠ê GENEL Sƒ∞STEM PUANI")
            print("-" * 30)
            
            # Puanlama kriterleri
            scores = {}
            
            # 1. Sinyal Aktivitesi (0-20 puan)
            if recent_signals > 100:
                scores['aktivite'] = 20
            elif recent_signals > 50:
                scores['aktivite'] = 15
            elif recent_signals > 20:
                scores['aktivite'] = 10
            else:
                scores['aktivite'] = 5
            
            # 2. AI Skor Kalitesi (0-20 puan)
            if ai_stats[0] > 0.8:
                scores['ai_kalite'] = 20
            elif ai_stats[0] > 0.7:
                scores['ai_kalite'] = 15
            elif ai_stats[0] > 0.6:
                scores['ai_kalite'] = 10
            else:
                scores['ai_kalite'] = 5
            
            # 3. Ba≈üarƒ± Oranƒ± (0-30 puan)
            if completed_count > 0:
                if success_rate > 70:
                    scores['basari'] = 30
                elif success_rate > 60:
                    scores['basari'] = 25
                elif success_rate > 50:
                    scores['basari'] = 20
                elif success_rate > 40:
                    scores['basari'] = 15
                else:
                    scores['basari'] = 10
            else:
                scores['basari'] = 0
            
            # 4. Sistem Saƒülƒ±ƒüƒ± (0-15 puan)
            scores['saglik'] = system_health_score
            
            # 5. Veri Kalitesi (0-15 puan)
            if high_quality_percentage > 50:
                scores['veri_kalite'] = 15
            elif high_quality_percentage > 30:
                scores['veri_kalite'] = 10
            elif high_quality_percentage > 15:
                scores['veri_kalite'] = 5
            else:
                scores['veri_kalite'] = 0
            
            # Toplam puan
            total_score = sum(scores.values())
            max_score = 100
            
            print("Puanlama Detaylarƒ±:")
            for category, score in scores.items():
                print(f"  {category.replace('_', ' ').title()}: {score}/20")
            
            print(f"\nüéØ TOPLAM Sƒ∞STEM PUANI: {total_score}/{max_score}")
            
            # Puan deƒüerlendirmesi
            if total_score >= 85:
                grade = "A+ (M√ºkemmel)"
                emoji = "üåü"
            elif total_score >= 75:
                grade = "A (√áok ƒ∞yi)"
                emoji = "‚≠ê"
            elif total_score >= 65:
                grade = "B+ (ƒ∞yi)"
                emoji = "üëç"
            elif total_score >= 55:
                grade = "B (Orta)"
                emoji = "üòê"
            elif total_score >= 45:
                grade = "C (Geli≈ütirilmeli)"
                emoji = "‚ö†Ô∏è"
            else:
                grade = "D (Kritik)"
                emoji = "üö®"
            
            print(f"{emoji} Sƒ∞STEM NOTU: {grade}")
            
            # ƒ∞yile≈ütirme √∂nerileri
            print("\nüí° ƒ∞Yƒ∞LE≈ûTƒ∞RME √ñNERƒ∞LERƒ∞")
            print("-" * 30)
            
            if scores['aktivite'] < 15:
                print("‚Ä¢ Sinyal √ºretim sƒ±klƒ±ƒüƒ±nƒ± artƒ±rƒ±n")
            
            if scores['ai_kalite'] < 15:
                print("‚Ä¢ AI modellerini yeniden eƒüitin")
            
            if scores['basari'] < 20:
                print("‚Ä¢ Sinyal filtreleme kriterlerini sƒ±kƒ±la≈ütƒ±rƒ±n")
            
            if scores['saglik'] < 10:
                print("‚Ä¢ Sistem bakƒ±mƒ± yapƒ±n")
            
            if scores['veri_kalite'] < 10:
                print("‚Ä¢ Veri kalitesini artƒ±rƒ±n")
            
            return total_score, grade
            
    except Exception as e:
        logger.error(f"Sistem deƒüerlendirme hatasƒ±: {e}")
        return 0, "Hata"

if __name__ == "__main__":
    score, grade = evaluate_system_performance()
    print(f"\nüìã √ñZET: Sistem {score}/100 puan aldƒ± - {grade}") 