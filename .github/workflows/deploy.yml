name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 185.209.228.189
        username: root
        password: '@198711Ad@'
        port: 22
        script: |
          # Sistem gÃ¼ncellemesi
          apt update -y
          apt upgrade -y
          
          # Python 3.11 ve development tools kurulumu
          apt install -y python3.11 python3.11-venv python3.11-pip python3.11-dev
          apt install -y build-essential gcc g++ make
          apt install -y python3-dev python3-pip
          
          # Git kurulumu
          apt install -y git
          
          # PostgreSQL kurulumu ve konfigÃ¼rasyonu
          apt install -y postgresql postgresql-contrib
          systemctl start postgresql
          systemctl enable postgresql
          
          # PostgreSQL kullanÄ±cÄ±sÄ±nÄ± oluÅŸtur
          sudo -u postgres createuser --interactive --pwprompt laravel || true
          sudo -u postgres psql -c "ALTER USER laravel PASSWORD 'secret';"
          
          # TA-Lib kurulumu
          cd /tmp
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          make install
          
          # Proje dizini oluÅŸturma
          mkdir -p /var/www/html
          cd /var/www/html
          
          # Mevcut projeyi sil ve yeniden klonla
          rm -rf kahin
          git clone https://github.com/ahmetdaldemir/kahinali.git kahin
          cd kahin
          
          # Virtual environment oluÅŸtur
          python3.11 -m venv venv
          source venv/bin/activate
          
          # BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
          pip install --upgrade pip
          pip install wheel setuptools
          
          # TA-Lib'i Ã¶nce kur
          pip install TA-Lib
          
          # DiÄŸer baÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
          pip install -r requirements.txt
          
          # PostgreSQL konfigÃ¼rasyonu
          sudo -u postgres psql -c "CREATE DATABASE kahin_ultima;"
          sudo -u postgres psql -c "CREATE USER laravel WITH PASSWORD 'secret';"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE kahin_ultima TO laravel;"
          sudo -u postgres psql -c "ALTER USER laravel CREATEDB;"
          
          # Gerekli dizinleri oluÅŸtur
          mkdir -p logs signals data models
          
          # Otomatik veritabanÄ± migration'Ä± Ã§alÄ±ÅŸtÄ±r
          echo "ğŸš€ VeritabanÄ± migration baÅŸlatÄ±lÄ±yor..."
          source venv/bin/activate
          python3 database_migration.py
          
          # Migration baÅŸarÄ±sÄ±zsa tekrar dene
          if [ $? -ne 0 ]; then
            echo "âŒ Migration baÅŸarÄ±sÄ±z, tekrar deneniyor..."
            sleep 5
            source venv/bin/activate
            python3 database_migration.py
          fi
          
          # Systemd service dosyalarÄ±nÄ± kopyala
          cp kahinali.service /etc/systemd/system/
          cp kahinali-web.service /etc/systemd/system/
          
          # Systemd'yi yeniden yÃ¼kle
          systemctl daemon-reload
          
          # Servisleri etkinleÅŸtir ve baÅŸlat
          systemctl enable kahinali.service
          systemctl enable kahinali-web.service
          systemctl start kahinali.service
          systemctl start kahinali-web.service
          
          # Servis durumlarÄ±nÄ± kontrol et
          systemctl status kahinali.service
          systemctl status kahinali-web.service
          
          # Firewall ayarlarÄ±
          ufw allow 5000
          ufw allow 22
          ufw --force enable
          
          # VeritabanÄ± tablolarÄ±nÄ± kontrol et
          echo "ğŸ“Š VeritabanÄ± tablolarÄ± kontrol ediliyor..."
          sudo -u postgres psql -d kahin_ultima -c "\dt"
          sudo -u postgres psql -d kahin_ultima -c "SELECT COUNT(*) FROM signals;"
          
          echo "Deployment completed successfully!" 