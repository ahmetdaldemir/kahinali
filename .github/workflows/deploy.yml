name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 185.209.228.189
        username: root
        password: '@198711Ad@'
        port: 22
        script: |
          # Sistem gÃ¼ncellemesi (CentOS/RHEL iÃ§in)
          yum update -y
          
          # Gerekli paketleri kur (CentOS/RHEL iÃ§in)
          yum install -y epel-release
          yum groupinstall -y "Development Tools"
          yum install -y python3 python3-pip python3-devel
          yum install -y git wget curl
          yum install -y postgresql postgresql-server postgresql-contrib
          yum install -y gcc gcc-c++ make
          
          # PostgreSQL'i baÅŸlat
          postgresql-setup initdb
          systemctl start postgresql
          systemctl enable postgresql
          
          # PostgreSQL kullanÄ±cÄ±sÄ±nÄ± oluÅŸtur
          sudo -u postgres createuser --interactive --pwprompt laravel || true
          sudo -u postgres psql -c "ALTER USER laravel PASSWORD 'secret';"
          
          # Proje dizini oluÅŸturma
          mkdir -p /var/www/html
          cd /var/www/html
          
          # Mevcut projeyi sil ve yeniden klonla
          rm -rf kahin
          git clone https://github.com/ahmetdaldemir/kahinali.git kahin
          cd kahin
          
          # Virtual environment oluÅŸtur
          python3 -m venv venv
          source venv/bin/activate
          
          # BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
          pip install --upgrade pip
          pip install wheel setuptools
          
          # TA-Lib yerine ta kullan (CentOS'ta TA-Lib sorunlu)
          pip install ta
          
          # DiÄŸer baÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
          pip install -r requirements.txt
          
          # PostgreSQL konfigÃ¼rasyonu
          sudo -u postgres psql -c "CREATE DATABASE kahin_ultima;"
          sudo -u postgres psql -c "CREATE USER laravel WITH PASSWORD 'secret';"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE kahin_ultima TO laravel;"
          sudo -u postgres psql -c "ALTER USER laravel CREATEDB;"
          
          # Gerekli dizinleri oluÅŸtur
          mkdir -p logs signals data models
          
          # Otomatik veritabanÄ± migration'Ä± Ã§alÄ±ÅŸtÄ±r
          echo "ğŸš€ VeritabanÄ± migration baÅŸlatÄ±lÄ±yor..."
          source venv/bin/activate
          python3 database_migration.py
          
          # Migration baÅŸarÄ±sÄ±zsa zorla tablo oluÅŸtur
          if [ $? -ne 0 ]; then
            echo "âŒ Migration baÅŸarÄ±sÄ±z, zorla tablo oluÅŸturma deneniyor..."
            python3 force_create_tables.py
          fi
          
          # Manuel tablo oluÅŸturma (ek gÃ¼venlik iÃ§in)
          echo "ğŸ”„ Manuel tablo oluÅŸturma Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
          chmod +x manual_create_tables.sh
          ./manual_create_tables.sh
          
          # Systemd service dosyalarÄ±nÄ± kopyala
          cp kahinali.service /etc/systemd/system/
          cp kahinali-web.service /etc/systemd/system/
          
          # Systemd'yi yeniden yÃ¼kle
          systemctl daemon-reload
          
          # Servisleri etkinleÅŸtir ve baÅŸlat
          systemctl enable kahinali.service
          systemctl enable kahinali-web.service
          systemctl start kahinali.service
          systemctl start kahinali-web.service
          
          # Servis durumlarÄ±nÄ± kontrol et
          systemctl status kahinali.service
          systemctl status kahinali-web.service
          
          # Firewall ayarlarÄ± (CentOS/RHEL iÃ§in)
          systemctl start firewalld
          systemctl enable firewalld
          firewall-cmd --permanent --add-port=5000/tcp
          firewall-cmd --permanent --add-port=22/tcp
          firewall-cmd --reload
          
          # VeritabanÄ± tablolarÄ±nÄ± kontrol et
          echo "ğŸ“Š VeritabanÄ± tablolarÄ± kontrol ediliyor..."
          sudo -u postgres psql -d kahin_ultima -c "\dt"
          sudo -u postgres psql -d kahin_ultima -c "SELECT COUNT(*) FROM signals;"
          
          echo "Deployment completed successfully!" 