name: Deploy to Kahinapp.com

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Deploy to kahinapp.com
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 185.209.228.189
        username: root
        password: '@198711Ad@'
        port: 22
        script: |
          cd /var/www/html/kahin

          if [ ! -d ".git" ]; then
            echo "[INFO] .git yok, dizin temizleniyor ve klonlanÄ±yor."
            rm -rf ./*
            git clone https://github.com/ahmetdaldemir/kahinali.git .
          else
            echo "[INFO] .git bulundu, gÃ¼ncelleniyor."
            git pull origin main
          fi

          if [ ! -f requirements.txt ]; then
            echo "[ERROR] requirements.txt bulunamadÄ±!"
            exit 1
          fi

          python3 -m venv venv
          source venv/bin/activate
          python3 -m pip install --upgrade pip
          pip install -r requirements.txt

          sudo systemctl stop kahinali.service 2>/dev/null || true
          pkill -f "python.*main.py" 2>/dev/null || true

          sudo tee /etc/systemd/system/kahinali.service > /dev/null <<EOF
          [Unit]
          Description=Kahinali Trading Bot for kahinapp.com
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=/var/www/html/kahin
          Environment=PATH=/var/www/html/kahin/venv/bin
          ExecStart=/var/www/html/kahin/venv/bin/python main.py
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=multi-user.target
          EOF

          sudo systemctl daemon-reload
          sudo systemctl enable kahinali.service
          sudo systemctl start kahinali.service

          sleep 15
          if sudo systemctl is-active --quiet kahinali.service; then
            echo "âœ… Deployment successful! Kahinali service is running on kahinapp.com"
            sudo systemctl status kahinali.service
            echo "ðŸ“Š Service logs:"
            sudo journalctl -u kahinali.service -n 10
          else
            echo "âŒ Deployment failed! Service is not running."
            sudo systemctl status kahinali.service
            echo "ðŸ“‹ Recent logs:"
            sudo journalctl -u kahinali.service -n 20
            exit 1
          fi 